---
title: "Quantifying rhythmicity with LimoRhyde2"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{quantifying-rhythmicity}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  rmarkdown.html_vignette.check_title = FALSE
)
#add intro and headers
```

We begin by preparing the R environment.

```{r setup}
library(limorhyde2)
library(data.table)
library(ggplot2)
library(qs)

dataPath = '../data/' #check where to store data
```
Next, we load the sample data.

```{r}
load(file.path(dataPath, 'mouse_liver_d.rda')) #save as qs
load(file.path(dataPath, 'mouse_liver_md.rda')) #save as qs 
```

The first step of the LimoRhyde2 workflow is to fit a series of linear models for each genomic feature. For the example data, the name of the column containing the time at which a sample was taken is 'time'.

```{r, results='hide'}
fit = getModelFit(y = mouse_liver_d, metadata = mouse_liver_md, 
                timeColname = 'time')
```

Next, we obtain a model with moderated estimates using `getPosteriorFit`. We use
the argument `covMethod = 'data-driven'` to fit a model based on covariance matrices
generated from the data.

```{r, results='hide'}
#consider removiing covMethod arg
#add more detail on what functions are doing at a high level
fit = getPosteriorFit(fit, covMethod = 'data-driven')
```

From the moderated model, we can get obtain estimates of the rhythmic statistics
for a select set of genes using `getRhythmStats`. Note that `getRhythmStats` can
be used with any `limorhyde2` fit object, moderated or raw.

```{r}
# by default, getRhythmStats estimates from posterior mean coefs, but can also use raw
# pick clock genes for sample
set.seed(21056)
sampleGenes = sample(rownames(mouse_liver_d), 3)


rhyStats = getRhythmStats(fit, features = sampleGenes)
rhyStats
```

We can also fit time courses based on the moderated estimates using `getFittedValues`.

```{r, results='hide'}
#reword 'fit time courses'
fittedVals = getFittedValues(fit, times = seq(0, 24, by = 2), features = sampleGenes)
```

Below, we plot the fitted values from the moderated model.

```{r, fig.align='center', fig.width=8, fig.asp=0.5625}

# more specific axis titles
# geom_point for actual vals, geom line for fit
# show gene symbols instead of ids, or give gene names in text
ggplot(data = fittedVals, aes(x = time, y = value)) +
  geom_line() +
  facet_wrap(vars(feature), scales = 'free_y') +
  ylab('expression')

```